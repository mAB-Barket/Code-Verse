/* ============================================
   CodeVerse - Multi-Language Learning Platform
   Advanced JavaScript Engine v2.0
   ============================================ */

document.addEventListener('DOMContentLoaded', function () {

    // =========================
    // THEME MANAGEMENT
    // =========================
    const themeToggle = document.querySelector('.theme-toggle');
    const savedTheme = localStorage.getItem('codeverse-theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);

    if (themeToggle) {
        themeToggle.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('codeverse-theme', next);
            updateThemeIcon(next);
        });
    }

    function updateThemeIcon(theme) {
        if (!themeToggle) return;
        themeToggle.innerHTML = theme === 'dark' ? '&#9728;' : '&#9790;';
        themeToggle.setAttribute('aria-label', theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode');
    }

    // =========================
    // STICKY HEADER SHADOW
    // =========================
    const header = document.querySelector('.site-header');
    if (header) {
        window.addEventListener('scroll', () => {
            header.classList.toggle('scrolled', window.scrollY > 10);
        }, { passive: true });
    }

    // =========================
    // MOBILE MENU
    // =========================
    const mobileBtn = document.querySelector('.mobile-menu-btn');
    const mainNav = document.querySelector('.main-nav');
    if (mobileBtn && mainNav) {
        mobileBtn.addEventListener('click', () => {
            mobileBtn.classList.toggle('active');
            mainNav.classList.toggle('mobile-open');
            document.body.style.overflow = mainNav.classList.contains('mobile-open') ? 'hidden' : '';
        });
        // Close on link click (but not on dropdown toggle)
        mainNav.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', (e) => {
                // Don't close menu if this is a dropdown toggle
                if (link.closest('.nav-dropdown') && link.parentElement.classList.contains('nav-dropdown')) {
                    // This is the "Languages â–¾" toggle link
                    if (window.innerWidth <= 768) {
                        e.preventDefault();
                        link.parentElement.classList.toggle('dropdown-open');
                        return;
                    }
                }
                mobileBtn.classList.remove('active');
                mainNav.classList.remove('mobile-open');
                document.body.style.overflow = '';
            });
        });
    }

    // =========================
    // BACK TO TOP
    // =========================
    const backToTop = document.querySelector('.back-to-top');
    if (backToTop) {
        window.addEventListener('scroll', () => {
            backToTop.classList.toggle('visible', window.scrollY > 400);
        }, { passive: true });
        backToTop.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }

    // =========================
    // SCROLL ANIMATIONS
    // =========================
    const animElements = document.querySelectorAll('.animate-on-scroll');
    if (animElements.length > 0) {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1, rootMargin: '0px 0px -40px 0px' });
        animElements.forEach(el => observer.observe(el));
    }

    // =========================
    // TABS
    // =========================
    document.querySelectorAll('.tabs').forEach(tabContainer => {
        const buttons = tabContainer.querySelectorAll('.tab-btn');
        const parentSection = tabContainer.closest('section') || tabContainer.parentElement;
        const contents = parentSection.querySelectorAll('.tab-content');

        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                buttons.forEach(b => b.classList.remove('active'));
                contents.forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                const target = document.getElementById(btn.dataset.tab);
                if (target) target.classList.add('active');
            });
        });
    });

    // =========================
    // QUIZ ENGINE
    // =========================
    document.querySelectorAll('.quiz-section').forEach(quizSection => {
        const options = quizSection.querySelectorAll('.quiz-option');
        const submitBtn = quizSection.querySelector('.submit-quiz');
        let submitted = false;

        options.forEach(option => {
            option.addEventListener('click', function () {
                if (submitted) return;
                const siblings = this.parentElement.children;
                Array.from(siblings).forEach(s => s.classList.remove('selected'));
                this.classList.add('selected');
            });
        });

        if (submitBtn) {
            submitBtn.addEventListener('click', function () {
                if (submitted) return;
                submitted = true;
                let score = 0;
                let total = quizSection.querySelectorAll('.quiz-question').length;

                options.forEach(option => {
                    if (option.classList.contains('selected')) {
                        if (option.dataset.correct === 'true') {
                            option.classList.add('correct');
                            score++;
                        } else {
                            option.classList.add('incorrect');
                        }
                    }
                    if (option.dataset.correct === 'true' && !option.classList.contains('selected')) {
                        option.classList.add('correct');
                    }
                    // Disable further clicks
                    option.style.pointerEvents = 'none';
                });

                const percentage = Math.round((score / total) * 100);
                this.textContent = `Score: ${score}/${total} (${percentage}%)`;
                this.disabled = true;

                // Save progress
                const pageId = document.body.dataset.page || window.location.pathname;
                const progress = JSON.parse(localStorage.getItem('codeverse-progress') || '{}');
                progress[pageId] = { score, total, percentage, date: new Date().toISOString() };
                localStorage.setItem('codeverse-progress', JSON.stringify(progress));

                // Show result message
                const resultDiv = document.createElement('div');
                resultDiv.className = `quiz-result ${percentage >= 60 ? 'pass' : 'fail'}`;
                resultDiv.textContent = percentage >= 60
                    ? `Great job! You scored ${percentage}%`
                    : `Keep practicing! You scored ${percentage}%. Review the material and try again.`;
                this.parentNode.insertBefore(resultDiv, this.nextSibling);
            });
        }
    });

    // =========================
    // CODE COPY BUTTON
    // =========================
    document.querySelectorAll('.code-copy-btn').forEach(btn => {
        btn.addEventListener('click', async function () {
            const codeBlock = this.closest('.code-block');
            const code = codeBlock.querySelector('pre')?.textContent || '';
            try {
                await navigator.clipboard.writeText(code);
                const original = this.innerHTML;
                this.innerHTML = '&#10003; Copied!';
                setTimeout(() => { this.innerHTML = original; }, 2000);
            } catch {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = code;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                const original = this.innerHTML;
                this.innerHTML = '&#10003; Copied!';
                setTimeout(() => { this.innerHTML = original; }, 2000);
            }
        });
    });

    // =========================
    // SEARCH FUNCTIONALITY
    // =========================
    const searchInput = document.querySelector('.search-input');
    if (searchInput) {
        const cards = document.querySelectorAll('.language-card, .topic-card');
        searchInput.addEventListener('input', function () {
            const query = this.value.toLowerCase().trim();
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(query) || query === '' ? '' : 'none';
            });
        });
    }

    // =========================
    // COUNTER ANIMATION
    // =========================
    const counters = document.querySelectorAll('.stat-number[data-count]');
    if (counters.length > 0) {
        const counterObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    animateCounter(entry.target);
                    counterObserver.unobserve(entry.target);
                }
            });
        }, { threshold: 0.5 });
        counters.forEach(c => counterObserver.observe(c));
    }

    function animateCounter(el) {
        const target = parseInt(el.dataset.count, 10);
        const suffix = el.dataset.suffix || '';
        const duration = 2000;
        const start = performance.now();

        function update(now) {
            const elapsed = now - start;
            const progress = Math.min(elapsed / duration, 1);
            const eased = 1 - Math.pow(1 - progress, 3); // ease-out cubic
            el.textContent = Math.round(target * eased).toLocaleString() + suffix;
            if (progress < 1) requestAnimationFrame(update);
        }
        requestAnimationFrame(update);
    }

    // =========================
    // HERO CODE TYPING EFFECT
    // =========================
    const typingTarget = document.querySelector('.typing-code');
    if (typingTarget) {
        const codeLines = JSON.parse(typingTarget.dataset.lines || '[]');
        let currentLine = 0;
        let currentChar = 0;
        let isDeleting = false;
        let pauseTimeout = null;

        function typeCode() {
            if (codeLines.length === 0) return;
            const line = codeLines[currentLine];

            if (!isDeleting) {
                typingTarget.innerHTML = line.substring(0, currentChar + 1) + '<span class="typing-cursor">|</span>';
                currentChar++;
                if (currentChar === line.length) {
                    pauseTimeout = setTimeout(() => { isDeleting = true; typeCode(); }, 2500);
                    return;
                }
                setTimeout(typeCode, 40 + Math.random() * 30);
            } else {
                typingTarget.innerHTML = line.substring(0, currentChar) + '<span class="typing-cursor">|</span>';
                currentChar--;
                if (currentChar < 0) {
                    isDeleting = false;
                    currentChar = 0;
                    currentLine = (currentLine + 1) % codeLines.length;
                    setTimeout(typeCode, 500);
                    return;
                }
                setTimeout(typeCode, 20);
            }
        }
        setTimeout(typeCode, 1000);
    }

    // =========================
    // PROGRESS TRACKING
    // =========================
    const progressFill = document.querySelector('.progress-fill');
    if (progressFill && progressFill.dataset.progress) {
        setTimeout(() => {
            progressFill.style.width = progressFill.dataset.progress + '%';
        }, 300);
    }

    // Active sidebar link highlighting
    const currentPath = window.location.pathname.split('/').pop() || 'index.html';
    document.querySelectorAll('.sidebar-nav a, .main-nav a').forEach(link => {
        const href = link.getAttribute('href');
        if (href === currentPath) {
            link.classList.add('active');
        }
    });

    // =========================
    // SMOOTH ANCHOR SCROLLING
    // =========================
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                e.preventDefault();
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });

    // =========================
    // KEYBOARD SHORTCUTS
    // =========================
    document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + K for search focus
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            const searchEl = document.querySelector('.search-input');
            if (searchEl) searchEl.focus();
        }
    });

    // =========================
    // LAZY LOAD IFRAMES
    // =========================
    document.querySelectorAll('iframe[data-src]').forEach(iframe => {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    iframe.src = iframe.dataset.src;
                    observer.unobserve(iframe);
                }
            });
        }, { rootMargin: '200px' });
        observer.observe(iframe);
    });

});
